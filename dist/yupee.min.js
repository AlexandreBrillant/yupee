const $$=($$=>{let debugMode=false;let deepTrace=false;let traceMode=0;function _trace(actionId,...params){if(debugMode){const paramstr=params.join(",");const log=`** [${actionId}] ** ${paramstr}`;if(traceMode==$$.KEYS.DEBUG_CONSOLE){console.log(log)}else{document.body.insertAdjacentHTML("beforeend",`<div class='yuptrace'>${log}</div>`)}if(deepTrace){params.forEach(element=>{if(typeof element=="object"){if(traceMode==$$.KEYS.DEBUG_CONSOLE)console.log(element);else{document.body.insertAdjacentHTML("beforeend",`<div class='yuptrace'>${log}</div>`)}}})}}}function _criticalError(actionId,...params){const paramstr=params.join(",");const log=`Critical Error [${actionId}] ** ${paramstr}`;$$.alert&&$$.alert(log);console.log(log);console.log((new Error).stack)}class Yupees{static#singleton=null;static#singletonController=true;static instance(){if(Yupees.#singleton==null){Yupees.#singletonController=false;Yupees.#singleton=new Yupees;Yupees.#singletonController=true}return Yupees.#singleton}constructor(){if(Yupees.#singletonController)throw new"Illegal usage for the Yupees, use Yupees.instance()"}#yupeesStack=[];#startLoading=false;#listeners={};#data={};#applicationModel=null;applicationModel(content){this.#applicationModel=this.#applicationModel??new YupModel(content);return this.#applicationModel}listen(eventId,handler){if(typeof this.#listeners[eventId]=="undefined"){this.#listeners[eventId]=[]}this.#listeners[eventId].push({handler:handler});_trace("listen",eventId,handler)}fire(eventId,...args){if(this.#listeners[eventId]){this.#listeners[eventId].forEach(obj=>{const handler=obj.handler;handler(...args)})}_trace("fire",eventId,args)}data(key,...args){if(args.length==0){if(typeof this.#data[key]=="undefined"){return null}else return this.#data[key]}else{this.#data[key]=args[0]}_trace("data",key,args)}loadComponent(location,params){this.#yupeesStack.push({location:location,params:params});if(!this.#startLoading){this.#startLoading=true;this.loadNextComponent()}}#currentParams=null;#currentYupId=null;#yupidFromLocation(location){const pathSep=location.lastIndexOf("/");if(pathSep>-1)return location.substring(pathSep+1);return location}loadNextComponent(){const component=this.#yupeesStack.shift();if(typeof component!="undefined"){let{location:location,params:params}=component;this.#currentYupId=this.#yupidFromLocation(location);if(!location.match(/\.js$/))location+=".js";this.#currentParams=params;Provider.instance().loadYup(location).then(()=>{Yupees.#singleton.loadNextComponent()}).catch(error=>{_trace("load",error,error.stack);_criticalError("load yup",location);$$.exit(1)})}else{this.fire($$.KEYS.EVENT_READY)}}start(config){config=config||{};config.yupid=this.#currentYupId;config.params=this.#currentParams;const currentComponent=new Yup(config);_trace("start",this.#currentYupId);return currentComponent}exit(exitCode){this.#yupeesStack=[];this.#startLoading=false}}class YupModel{#content={};#yups=[];constructor(content){content&&(this.#content=content)}reset(newContent){this.#content=newContent}#submodels={};subModel(majorKey){if(this.#submodels[majorKey]){return this.#submodels[majorKey]}!this.#content[majorKey]&&(this.#content[majorKey]={});const submodel=new YupModel(this.#content[majorKey]);this.#submodels[majorKey]=submodel;return submodel}_addYup(yupcomponent){this.#yups.push(yupcomponent)}_removeYup(yupcomponent){const index=this.#yups.indexOf(yupcomponent);index>-1&&this.#yups.splice(index,1)}pushData(key,data,update=false){this.#content[key]=this.#content[key]??[];this.#content[key].push(data);if(update){this.update(key)}}update(flags,includeSubModel=false){this.#yups.forEach(yup=>yup.paint({flags:flags}));if(includeSubModel&&this.#submodels){for(const key in this.#submodels){this.#submodels[key].update(flags,includeSubModel)}}}data(key,value,update=false){if(typeof key=="undefined")return this.#content;if(!value){return this.#content[key]}this.#content[key]=value;if(update)this.update(key);return value}dump(){console.log("*** Start Dump Model ***");console.log(this.#content);this.#yups.forEach(yup=>console.log("-> Yup user ["+yup.yupid()+"]"));console.log("*** End Dump Model ***")}toJSON(){return JSON.stringify(this.#content)}fromJSON(jsonStr){this.#content=JSON.parse(jsonStr)}}class YupContainer{#$;constructor(node){this.#$=node}node(newContainer){newContainer&&(this.#$=newContainer);return this.#$}id(newId){newId&&(this.#$.id=newId);return this.#$.id}setAttribute(key,value){this.#$.setAttribute(key,value)}getAttribute(key){return this.#$.dataset[key]||this.#$.getAttribute(key)}hasAttribute(key){return key in this.#$.dataset||this.#$.hasAttribute(key)}attributes(){return this.#$.attributes}parentNode(){return this.#$.parentNode}isParent(container){return container.node()==this.parentNode()}lastChild(){return this.#$.lastChild}appendChild(newChild){if(newChild instanceof YupContainer){newChild=newChild.node()}if(typeof newChild=="string"){this.#$.insertAdjacentHTML("beforeend",newChild)}else this.#$.appendChild(newChild)}removeChild(child){if(child instanceof YupContainer){child=child.node()}this.#$.removeChild(child)}querySelector(selector){return this.#$.querySelector(selector)}querySelectorAll(selector){return this.#$.querySelectorAll(selector)}style(values){for(let property in values){this.#$.style[property]=values[property]}return this}event(evt,handler){this.#$.addEventListener(evt,handler)}textContent(){return this.#$.textContent}value(content){if(typeof content=="undefined")return this.#$.value;else this.#$.value=content}clean(){while(this.#$.firstChild)this.#$.removeChild(this.#$.firstChild)}}class Yup{#$;#yupid;#model;#childid=1;#parent=null;constructor({yupid:yupid,model:model,renderer:renderer,template:template,container:container,params:params}){this.#yupid=yupid;if(params){if(params instanceof Node){this.#$=new YupContainer(params)}else if(params._into){this.#$=new YupContainer(params._into);delete params._into}}if(!this.#$){this.#$=new YupContainer(document.createElement("DIV"));yupid&&this.#$.id(yupid)}if(params){for(const key in params){if(typeof params[key]=="string")this.#$.setAttribute(key,params[key])}}model&&this.model(model);renderer&&this.renderer(renderer);template&&(this.#template=template);container&&(this.#$=new YupContainer(container));!this.#model&&$$.application.hasModel()&&this.model($$.application.model())}#children={};#childrenLst=[];#generate_newid(){return"yup"+this.#childid++}#setchild(name,yup){yup.#parent=this;this.#children[name]=yup;this.#childrenLst.push(yup);!yup.container().parentNode()&&this.container().appendChild(yup.container());return yup}addChild(content){let yupid;let container;if(content instanceof Yup){yupid=content.yupid();return this.#setchild(yupid,content)}else if(typeof content=="string"||content.html){this.container().appendChild(content.html||content);container=this.container().lastChild()}else if(content.node||content instanceof Node){container=content.node||content}else{let{selector:selector}=content;selector=selector||content.select;if(selector){container=this.container().querySelector(selector)}}if(!container){this.trace("Invalid addChild parameter no container ?");this.trace(content);return null}!yupid&&(yupid=content.yupid);!yupid&&(yupid=container.id||container.dataset.yupid||container.getAttribute("yupid"));!yupid&&(yupid=this.#generate_newid());const yup=new Yup({yupid:yupid,container:container});content.click&&yup.click(content.click);return this.#setchild(yupid,yup)}addChildren({select:select,selector:selector,click:click}){const yups=[];const lst=this.#$.querySelectorAll(select||selector);lst&&lst.forEach(node=>{yups.push(this.addChild({node:node,click:click}))});return yups}#removeChildReference(child){const id=this.yupid();id&&delete this.#children[id];const index=this.#childrenLst.indexOf(child);index>-1&&this.#childrenLst.splice(index,1)}remove(){this.#model&&this.#model._removeYup(this);const parent=this.parent();parent.#removeChildReference(this);if(this.container().node()instanceof DocumentFragment){const fragment=this.container().node();while(fragment.firstChild){parent.container().removeChild(fragment.firstChild)}}else{if(this.container().isParent(parent.container()))parent.container().removeChild(this.container())}}child(childName){return this.#children[childName]}childCount(){return this.#childrenLst.length}childAt(index){return this.#childrenLst[index]}parent(){return this.#parent}trace(message){_trace(`Yup[${this.#yupid}] => (${message})`)}#binder(func){const that=this;return function(...args){args.push(that);func.apply(that,args)}}model(newmodel){if(newmodel){if(this.#model){this.#model._removeYup(this)}newmodel._addYup(this);this.#model=newmodel}if(!this.#model){return this.model(new YupModel)}return this.#model}pushData(data,repaintMode){this.model().pushData("items",data,repaintMode)}produce(name,value){Yupees.instance().fire("data:"+name,value)}consume(name,handler){Yupees.instance().listen("data:"+name,handler)}#modelRenderer=null;renderer(modelRenderer){if(!this.#modelRenderer)this.#modelRenderer=modelRenderer;return this.#modelRenderer}param(paramKey,defaultValue){if(typeof paramKey=="string"){const attValue=this.container().getAttribute(paramKey);return attValue||defaultValue}else{const{name:name,value:value}=paramKey;if(name&&value){if(!this.container().hasAttribute(name)){this.container().setAttribute(name,value)}}return this}}#template=null;template(values){let content=null;const templateName=this.param("data-template")||this.param("template")||this.#template;if(templateName){content=$$.application.templates[templateName];content&&(content=this.#resolveTemplate(content,values))}return content}#resolveTemplate(content,values){return content.replace(/{(\w+)}/g,(match,param)=>values[param]||"")}#buffer=null;paint(html){if(typeof html=="undefined"||typeof html=="object"&&"flags"in html){if(this.#model){if(this.#modelRenderer){this.clean();this.#modelRenderer({model:this.model(),container:this.container().node(),template:this.template(),flags:html.flags})}else{if($$.application.renderer){this.clean();$$.application.renderer({model:this.model(),container:this.container().node(),template:this.template(),flags:html.flags})}}}}else{if(html instanceof Node){this.clean();this.#$.appendChild(html)}else{if(typeof html=="object")html=this.template(html)}if(typeof html=="string"){this.clean();!this.#buffer&&(this.#buffer=document.createElement("DIV"));this.#buffer.innerHTML=html;while(this.#buffer.firstChild){this.#$.appendChild(this.#buffer.firstChild)}}}return this}style(values){this.#$.style(values);return this}event(evt,handler){this.#$.event(evt,this.#binder(handler));return this}click(childname,handler){if(typeof childname=="function"){this.event("click",childname)}else{if(typeof childname=="string"){let child=this.child(childname);if(child==null){if(childname==$$.KEYS.AUTO_HANDLER){child=this;handler=$$.KEYS.AUTO_HANDLER}else{this.trace("click : Unknown child "+childname);return}}if(handler==$$.KEYS.AUTO_HANDLER){child.event("click",()=>{child.produce($$.KEYS.EVENT_YUPID,child.yupid())})}else child.event("click",handler)}}}newContainer(cssselector,keepparams=false){try{const node=document.querySelector(cssselector);if(node!=null){let oldattributes=null;if(keepparams){oldattributes=this.container().attributes()}this.#$.node(node);if(oldattributes){for(const att of oldattributes){this.param(att)}}}}catch(error){this.trace(`Invalid selector [${cssselector} / ${error.message}] ? using document.body`);this.#$.node(document.body)}return this}container(){return this.#$}clean(){if(!this.childCount()){const parentNode=this.container();while(parentNode.firstChild)parentNode.removeChild(parentNode.firstChild)}else{while(this.childCount()){this.childAt(0).remove()}}while(this.container().firstChild)this.container().removeChild(this.container().firstChild);return this}selectAll(cssSelector){return this.container().querySelectorAll(cssSelector)}select(cssSelector){return this.container().querySelector(cssSelector)}yupid(){return this.#yupid}show(displayMode="block"){this.style({display:displayMode})}hide(displayMode="none"){this.style({display:displayMode})}value(content){return this.container().value(content)}}const boot=(...args)=>{ready=document.body?true:false;init=()=>{let usage=null;if(args.length)usage=args[0];const yupees=Yupees.instance();if(typeof usage=="object"){const{load:load,params:params}=usage;yupees.loadComponent(load,params)}};if(ready)init();else{starting.push(init);document.addEventListener("DOMContentLoaded",()=>{ready=true;_startingAll()})}};(()=>{function resolve_yup_path(node){const t=[];while(node){if(node.nodeType==Node.ELEMENT_NODE&&node.hasAttribute("data-yup")){const yupid=node.dataset.yupid||node.getAttribute("yupid")||node.id;yupid&&t.unshift(yupid)}node=node.parentNode}return t.join("/")}function process_data_yup(){const nodes=document.querySelectorAll("*");for(node of nodes){let path=null;if($$.pathResolver)path=$$.pathResolver(node);path=!path&&node.dataset.yup;if(!path&&node.hasAttribute("data-yup")&&node.id){path="yups/"+resolve_yup_path(node)}if(path)$$.load(path,{_into:node})}}document.addEventListener("DOMContentLoaded",()=>{process_data_yup()})})();class Pages{static#singleton=null;static#singletonController=true;static instance(){if(Pages.#singleton==null){Pages.#singletonController=false;Pages.#singleton=new Pages;Pages.#singletonController=true}return Pages.#singleton}constructor(){if(Pages.#singletonController)throw new"Illegal usage for the Pages, use Pages.instance()"}#currentPage(){const current=window.location.pathname.split("/").pop();const page=current.split(".")[0];return document.body.dataset.page||document.body.getAttribute("page")||page}loadpage(page,keepContext=true){if(keepContext&&$$.application.hasModel()){const wholeModel=$$.application.model();if(wholeModel){const jsonModel=wholeModel.toJSON();Provider.instance().writeData(this.#currentPage(),jsonModel)}}Provider.instance().loadPage(page+"/main.html")}init(){Provider.instance().readData(this.#currentPage()).then(value=>{const wholeModelData=JSON.parse(value);$$.application.initModel(wholeModelData).update()})}}class Driver{constructor(){if(new.target==Driver){throw new Error("Invalid Driver class usage, you must use a descendant class")}}async loadYup(location){throw new Error("Invalid usage")}async loadPage(location){throw new Error("Invalid usage")}async readData(key){throw new Error("Invalid usage")}async writeData(key,value){throw new Error("Invalid usage")}}class LocalDriver extends Driver{async loadYup(location){return new Promise((resolve,reject)=>{const scriptNode=document.createElement("script");scriptNode.addEventListener("load",()=>resolve(true));scriptNode.addEventListener("error",()=>reject("can't load "+location));scriptNode.src=location;document.head.appendChild(scriptNode)})}async loadPage(location){return new Promise((resolve,reject)=>{window.location.href=location})}async readData(key){return new Promise((resolve,reject)=>{resolve(localStorage.getItem(key))})}async writeData(key,value){return new Promise((resolve,reject)=>{localStorage.setItem(key,value);resolve(true)})}}class Provider{static#singleton=null;static#singletonController=true;static instance(){if(Provider.#singleton==null){Provider.#singletonController=false;Provider.#singleton=new Provider;Provider.#singletonController=true}return Provider.#singleton}constructor(){if(Provider.#singletonController)throw new"Illegal usage for the Provider, use Provider.instance()"}async loadYup(location){return($$.driver||this.#defaultDriver).loadYup(location)}async loadPage(location){return($$.driver||this.#defaultDriver).loadPage(location)}async readData(key){return($$.driver||this.#defaultDriver).readData(key)}async writeData(key,value){return($$.driver||this.#defaultDriver).writeData(key,value)}#defaultDriver=new LocalDriver}function _startingAll(){if(starting){starting.forEach(starting=>starting())}starting=null}let starting=[];let ready=false;$$.start=config=>Yupees.instance().start(config);$$.load=(yupcomponent,params)=>{boot({load:yupcomponent,params:params});_trace("load",yupcomponent,params);return $$};$$.loadPage=(page,keepContext=true)=>{Pages.instance().loadpage(page,keepContext)};$$.pathResolver=null;$$.listen=(eventid,...actions)=>{actions.forEach(action=>Yupees.instance().listen(eventid,action));_trace(eventid,actions);return $$};$$.ready=(...actions)=>{Pages.instance().init();$$.listen($$.KEYS.EVENT_READY,...actions)};$$.fire=(eventid,...params)=>{Yupees.instance().fire(eventid,params);_trace("fire",eventid,params);return $$};$$.data=(key,...params)=>{if(params.length==0)return Yupees.instance().data(key,...params);Yupees.instance().data(key,...params);_trace("data",key,params);return $$};$$.application={initModel:content=>{if(!$$.application._model)$$.application._model=Yupees.instance().applicationModel(content);else $$.application._model.reset(content);return $$.application._model},model:()=>{if(!$$.application._model)throw new Error("No initialized model, use the initModel method");return $$.application._model},renderer:null,templates:{},update:flags=>{$$.application.model().update(flags)},hasModel:()=>$$.application._model};$$.driver=null;$$.DriverClass=Driver;$$.alert=msg=>alert(msg);$$.exit=exitCode=>{Yupees.instance().exit(exitCode)};$$.KEYS=Object.freeze({DEBUG_CONSOLE:0,DEBUG_BODY:1,EVENT_YUPID:"event/yupid",EVENT_READY:"event/ready",AUTO_HANDLER:"handler/auto"});$$.debugMode=mode=>{traceMode=mode??$$.KEYS.DEBUG_CONSOLE;debugMode=!debugMode};return $$})({}||$$);