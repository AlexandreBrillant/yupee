const $$=($$=>{let debugMode=false;let deepTrace=false;let traceMode=0;function _trace(actionId,...params){if(debugMode){const paramstr=params.join(",");const log=`** [${actionId}] ** ${paramstr}`;if(traceMode==$$.KEYS.DEBUG_CONSOLE)console.log(log);else{document.body.insertAdjacentHTML("beforeend",`<div class='yuptrace'>${log}</div>`)}if(deepTrace){params.forEach(element=>{if(typeof element=="object"){if(traceMode==$$.KEYS.DEBUG_CONSOLE)console.log(element);else{document.body.insertAdjacentHTML("beforeend",`<div class='yuptrace'>${log}</div>`)}}})}}}class Yupees{static#singleton=null;static#singletonController=true;static instance(){if(Yupees.#singleton==null){Yupees.#singletonController=false;Yupees.#singleton=new Yupees;Yupees.#singletonController=true}return Yupees.#singleton}constructor(){if(Yupees.#singletonController)throw new"Illegal usage for the Yupees, use Yupees.instance()"}#yupeesStack=[];#startLoading=false;#listeners={};#data={};#applicationModel=null;applicationModel(content){this.#applicationModel=this.#applicationModel??new YupModel(content);return this.#applicationModel}listen(eventId,handler){if(typeof this.#listeners[eventId]=="undefined"){this.#listeners[eventId]=[]}this.#listeners[eventId].push({handler:handler});_trace("listen",eventId,handler)}fire(eventId,...args){if(this.#listeners[eventId]){this.#listeners[eventId].forEach(obj=>{const handler=obj.handler;handler(...args)})}_trace("fire",eventId,args)}data(key,...args){if(args.length==0){if(typeof this.#data[key]=="undefined"){return null}else return this.#data[key]}else{this.#data[key]=args[0]}_trace("data",key,args)}loadComponent(location,params){this.#yupeesStack.push({location:location,params:params});if(!this.#startLoading){this.#startLoading=true;this.loadNextComponent()}}#currentParams=null;#currentYupId=null;#yupid(location){const pathSep=location.lastIndexOf("/");if(pathSep>-1)return location.substring(pathSep+1);return location}loadNextComponent(){const component=this.#yupeesStack.shift();if(typeof component!="undefined"){let{location:location,params:params}=component;this.#currentYupId=this.#yupid(location);if(!location.includes("."))location+=".js";const scriptNode=document.createElement("script");scriptNode.addEventListener("load",()=>{Yupees.#singleton.loadNextComponent()});scriptNode.addEventListener("error",()=>{_trace("load","Can't load "+location+" ?")});scriptNode.src=location;this.#currentParams=params;document.head.appendChild(scriptNode)}}start(config){const currentComponent=new Yup(this.#currentYupId,this.#currentParams,config);_trace("start",this.#currentYupId);return currentComponent}}class YupModel{#content={};#yups=[];constructor(content){content&&(this.#content=content)}#submodels={};subModel(majorKey){if(this.#submodels[majorKey]){return this.#submodels[majorKey]}!this.#content[majorKey]&&(this.#content[majorKey]={});const submodel=new YupModel(this.#content[majorKey]);this.#submodels[majorKey]=submodel;return submodel}_addYup(yupcomponent){this.#yups.push(yupcomponent)}_removeYup(yupcomponent){const index=this.#yups.indexOf(yupcomponent);index>-1&&this.#yups.splice(index,1)}pushData(key,data,repaintMode=true){this.#content[key]=this.#content[key]??[];this.#content[key].push(data);if(repaintMode){this.update()}}update(){this.#yups.forEach(yup=>yup.paint())}data(key,value,repaintMode=true){if(!value){return this.#content[key]}this.#content[key]=value;if(repaintMode)this.update();return value}dump(){console.log("*** Start Dump Model ***");console.log(this.#content);this.#yups.forEach(yup=>console.log("-> Yup user ["+yup.yupid()+"]"));console.log("*** End Dump Model ***")}}class Yup{#container;#params;#yupid;#model;#childid=1;#parent=null;constructor(yupid,params=null,config){this.#yupid=yupid;if(params){if(params instanceof Node){this.#container=params}else{if(params._into){this.#container=params._into;delete params._into}this.#params=params}}if(this.#container){if(this.#container.attributes){this.#params=this.#params||{};for(let attribute of this.#container.attributes){params[attribute.name]=attribute.value}}}if(!this.#container){this.#container=document.createElement("DIV");yupid&&(this.#container.id=yupid)}if(config){const{model:model,renderer:renderer}=config;model&&this.model(model);renderer&&this.renderer(renderer)}}#children={};#childrenLst=[];addChildBySelector(childName,selector){const node=this.container().querySelector(selector);if(node==null){this.trace("Unknown child ["+selector+"]")}else{this.#setchild(childName,new Yup(childName,node));return this.#children[childName]}}#setchild(name,yup){yup.#parent=this;this.#children[name]=yup;this.#childrenLst.push(yup);!yup.container().parentNode&&this.container().appendChild(yup.container());return yup}addChild(content,config){let yupid;let yup;if(content instanceof Yup){yupid=content.yupid();yup=content}else{if(typeof content=="object"){if(content.yupid&&content.yupcontent){yupid=content.yupid;content=content.yupcontent}}if(typeof content=="string"){this.container().insertAdjacentHTML("beforeend",content);content=this.container().lastChild}if(content instanceof Node){!yupid&&config&&(yupid=config.yupid);!yupid&&(yupid=yupid??"yup"+this.#childid++);yup=new Yup(yupid,content,config)}else{this.trace("Invalid addChild parameter (Yup object,string or Node) ?");this.trace(content);return null}}return this.#setchild(yupid,yup)}#removeChildReference(child){const id=this.yupid();id&&delete this.#children[id];const index=this.#childrenLst.indexOf(child);index>-1&&this.#childrenLst.splice(index,1)}remove(){this.#model&&this.#model._removeYup(this);const parent=this.parent();parent.#removeChildReference(this);if(this.container()instanceof DocumentFragment){const fragment=this.container();while(fragment.firstChild){parent.container().removeChild(fragment.firstChild)}}else parent.container().removeChild(this.container())}child(childName){return this.#children[childName]}childCount(){return this.#childrenLst.length}childAt(index){return this.#childrenLst[index]}parent(){return this.#parent}trace(message){_trace(`Yup[${this.#yupid}] => (${message})`)}#binder(func){const that=this;return function(...args){args.push(that);func.apply(that,args)}}model(newmodel){if(newmodel){if(this.#model){this.#model._removeYup(this)}newmodel._addYup(this);this.#model=newmodel}if(!this.#model){return this.model(new YupModel)}return this.#model}pushData(data,repaintMode){this.model().pushData("items",data,repaintMode)}produce(name,value){Yupees.instance().fire("data:"+name,value)}consume(name,handler){Yupees.instance().listen("data:"+name,handler)}#modelRenderer=null;renderer(modelRenderer){if(!this.#modelRenderer)this.#modelRenderer=modelRenderer;return this.#modelRenderer}param(paramkey,defaultValue){if(this.#params&&this.#params[paramkey])return this.#params[paramkey];return defaultValue}#buffer=null;paint(html){this.clean();if(typeof html=="undefined"){if(this.#modelRenderer){this.#modelRenderer(this.model(),this.container())}else{$$.defaultRenderer&&$$.defaultRenderer(this.model(),this.container())}}else{if(html instanceof Node){this.#container.appendChild(html)}else{if(typeof html=="string"){!this.#buffer&&(this.#buffer=document.createElement("DIV"));this.#buffer.innerHTML=html;while(this.#buffer.firstChild){this.#container.appendChild(this.#buffer.firstChild)}}else{this.trace("Unkown paint argument ["+html+"]")}}}return this}style(values){for(let property in values){this.#container.style[property]=values[property]}return this}event(evt,handler){this.#container.addEventListener(evt,this.#binder(handler));return this}click(childname,handler){if(typeof childname=="function"){this.event("click",childname)}else{if(typeof childname=="string"){let child=this.child(childname);if(child==null){if(childname=="auto"){child=this;handler="auto"}else{this.trace("click : Unknown child "+childname);return}}if(handler=="auto"){child.event("click",()=>{child.produce($$.KEYS.EVENT_YUPID,child.yupid())})}else child.event("click",handler)}}}into(cssselector){try{const node=document.querySelector(cssselector);if(node!=null){this.#container=node}}catch(error){this.trace(`Invalid selector [${cssselector} / ${error.message}] ? using document.body`);this.#container=document.body}return this}intoid(id){return this.into("@"+id)}container(){return this.#container}clean(){if(!this.childCount()){const parentNode=this.container();while(parentNode.firstChild)parentNode.removeChild(parentNode.firstChild)}else{while(this.childCount()){this.childAt(0).remove()}}return this}selectAll(cssSelector){return this.container().querySelectorAll(cssSelector)}select(cssSelector){return this.container().querySelector(cssSelector)}yupid(){return this.#yupid}show(displayMode="block"){this.style({display:displayMode})}hide(){this.style({display:"none"})}value(content){if(typeof content=="undefined")return this.container().value;else this.container().value=content}}function _startingAll(){if(starting){starting.forEach(starting=>starting())}starting=null}let starting=[];let ready=false;const starter=(...args)=>{ready=document.body?true:false;init=()=>{let usage=null;if(args.length)usage=args[0];const yupees=Yupees.instance();if(typeof usage=="object"){const{load:load,params:params}=usage;yupees.loadComponent(load,params)}};if(ready)init();else{starting.push(init);document.addEventListener("DOMContentLoaded",()=>{ready=true;_startingAll()})}};(()=>{function resolve_yup_path(node){const t=[];while(node){if(node.nodeType==Node.ELEMENT_NODE&&node.hasAttribute("data-yup")){if(node.id){t.unshift(node.id)}}node=node.parentNode}return t.join("/")}function process_data_yup(){const nodes=document.querySelectorAll("*");for(node of nodes){if(node.hasAttribute("data-yup")&&node.id){$$.load("yups/"+resolve_yup_path(node),{_into:node})}}}document.addEventListener("DOMContentLoaded",()=>{process_data_yup()})})();$$.starter=starter;$$.start=config=>Yupees.instance().start(config);$$.load=(yupcomponent,params)=>{starter({load:yupcomponent,params:params});_trace("load",yupcomponent,params);return $$};$$.listen=(eventid,...actions)=>{actions.forEach(action=>Yupees.instance().listen(eventid,action));_trace(eventid,actions);return $$};$$.fire=(eventid,...params)=>{Yupees.instance().fire(eventid,params);_trace("fire",eventid,params);return $$};$$.data=(key,...params)=>{if(params.length==0)return Yupees.instance().data(key,...params);Yupees.instance().data(key,...params);_trace("data",key,params);return $$};$$.applicationModel=content=>Yupees.instance().applicationModel(content);$$.KEYS=Object.freeze({DEBUG_CONSOLE:0,DEBUG_BODY:1,EVENT_YUPID:"yupid"});$$.debugMode=mode=>{traceMode=mode??$$.KEYS.DEBUG_CONSOLE;debugMode=!debugMode};return $$})({}||$$);